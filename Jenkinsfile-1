pipeline {
    agent any // This pipeline can run on any available agent

    stages {
        stage('Prepare') {
            steps {
                deleteDir()  // Deletes the current directory to ensure a clean start
            
            }
        }
        stage('SCM') {
            steps {
                checkout scm // Checks out source code from the SCM repository configured in Jenkins
            }
        }
        stage('Compile') {
            steps {
                sh './mvnw clean' // Runs Maven's clean command to remove target directory
                sh './mvnw compile' // Compiles the source code using Maven
            }
        }

        stage('SonarQube Analysis') { // Code analysis stage using SonarQube
            environment {
                SCANNER_HOME = tool 'sonar-scanner' // Sets the SonarQube scanner tool
                NODEJS_HOME = tool 'nodejs' // Sets the Node.js tool for JavaScript analysis
                PATH = "${env.NODEJS_HOME}/bin:${env.PATH}" // Updates PATH to include Node.js binaries
                mvn = tool 'M3' // Sets Maven tool
            }
            steps {
                withSonarQubeEnv('sq1') {
                    sh "${mvn}/bin/mvn sonar:sonar -Dsonar.projectKey=Web -Dsonar.projectName='Web' -Dsonar.sources=src/ -Dsonar.java.binaries=target/classes/ -Dsonar.exclusions=src/test/java/****/*.java"
                    // Runs Maven SonarQube analysis with specified parameters
                }
            }
        }

        stage('Build JAR') { // Jar building stage
            steps {
                sh './mvnw package' // Packages the application into a JAR file using Maven
            }
            post {
                success {
                    archiveArtifacts 'target/*.jar' // Archives the JAR file if the build is successful
                }
            }
        }
        stage('Deploy'){ // Deployment stage
            steps {
                sh 'JENKINS_NODE_COOKIE=dontKillMe nohup java -jar target/*.jar > output.log 2>&1 &'
                // Starts the JAR application in the background, redirecting output to a log file

                
            }
        }
    }
}
